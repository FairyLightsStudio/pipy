name: Release

on:
  push:
    tags:
      - '*'

permissions:
  contents: write # éœ€è¦æƒé™åˆ›å»º Release

env:
  IMAGE: flomesh/pipy
  PKG_NAME: pipy
  S3_PATH: repo/pipy

defaults:
  run:
    shell: bash

jobs:
  set-release-version:
    name: Set Version
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set RELEASE_VERSION
        id: version
        run: |
          CI_COMMIT_DATE=$(date +%Y%m%d%H%M)
          echo "CI_COMMIT_DATE=${CI_COMMIT_DATE}" >> $GITHUB_ENV
          git fetch --tags
          RELEASE_VERSION=`git name-rev --tags --name-only $(git rev-parse HEAD)`
          if [ $RELEASE_VERSION = 'undefined' ]; then
              echo "release_version=nightly-${CI_COMMIT_DATE}" >> $GITHUB_OUTPUT
          else
              echo "release_version=${RELEASE_VERSION}" >> $GITHUB_OUTPUT
          fi
    outputs:
      release_version: ${{steps.version.outputs.release_version}}

  build-core:
    name: Core ${{ matrix.os }} ${{ matrix.arch }}
    needs: set-release-version
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-24.04
            arch: x86_64
            setup: ""
          - os: ubuntu-24.04-arm
            arch: aarch64
            setup: ""
          - os: macos-13
            arch: x86_64
            setup: "export CC=$(brew --prefix llvm@15)/bin/clang; export CXX=$(brew --prefix llvm@15)/bin/clang++"
          - os: macos-latest
            arch: aarch64
            setup: "export CC=$(brew --prefix llvm@15)/bin/clang; export CXX=$(brew --prefix llvm@15)/bin/clang++"
    steps:
      - uses: actions/checkout@v4
      - name: Build
        id: build
        env:
          RELEASE_VERSION: ${{ needs.set-release-version.outputs.release_version }}
        run: |
          ${{ matrix.setup }}
          ./build.sh -p -t ${RELEASE_VERSION}
          # è¾“å‡ºæ–‡ä»¶åä¾›åŽç»­æ­¥éª¤ä½¿ç”¨
          echo "artifact_name=$(ls *${RELEASE_VERSION}*.tar.gz | head -n 1)" >> $GITHUB_OUTPUT

      - name: Upload to S3
        env:
          S3_KEY: ${{ secrets.S3_ACCESS_KEY }}
          ARTIFACT: ${{ steps.build.outputs.artifact_name }}
          RELEASE_VERSION: ${{ needs.set-release-version.outputs.release_version }}
        if: ${{ env.S3_KEY != '' }}

        run: |
          sudo apt-get install -y s3cmd || brew install s3cmd
          printf "[default]\naccess_key = %s\nsecret_key = %s\nhost_base = %s\nhost_bucket = %%(bucket)s.%s\n" \
          "${{ secrets.S3_ACCESS_KEY }}" "${{ secrets.S3_SECRET_KEY }}" \
          "${{ secrets.S3_GLOBAL_ACC_HOST_BASE }}" "${{ secrets.S3_GLOBAL_ACC_HOST_BASE }}" > ~/.s3cfg
          
          TARGET_PATH="${S3_PATH}/$(uname -m)/binary/${ARTIFACT}"
          [[ "$RELEASE_VERSION" == "nightly"* ]] && TARGET_PATH="${S3_PATH}-nightly/$(uname -m)/binary/${ARTIFACT}"
          
          s3cmd put ${ARTIFACT} s3://${{ secrets.S3_BUCKET }}/${TARGET_PATH}

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.build.outputs.artifact_name }}
          path: ${{ steps.build.outputs.artifact_name }}

  # 2. Docker æž„å»ºä»»åŠ¡
  build-docker:
    name: Docker ${{ matrix.arch }}
    needs: set-release-version
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          - arch: x86_64
            runner: ubuntu-latest
          - arch: aarch64
            runner: ubuntu-24.04-arm
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - name: Build Image
        id: build
        env:
          DOCKER_BUILDKIT: 1
          RELEASE_VERSION: ${{ needs.set-release-version.outputs.release_version }}
        run: |
          ./build.sh -ncp -t ${RELEASE_VERSION}
          echo "artifact_name=$(ls *${RELEASE_VERSION}*.tar.gz | head -n 1)" >> $GITHUB_OUTPUT

      - name: Upload to S3
        if: ${{ env.S3_KEY != '' }}
        env:
          S3_KEY: ${{ secrets.S3_ACCESS_KEY }}
          ARTIFACT: ${{ steps.build.outputs.artifact_name }}
          RELEASE_VERSION: ${{ needs.set-release-version.outputs.release_version }}
        run: |
          sudo apt-get install -y s3cmd
          printf "[default]\naccess_key = %s\nsecret_key = %s\nhost_base = %s\nhost_bucket = %%(bucket)s.%s\n" \
          "${{ secrets.S3_ACCESS_KEY }}" "${{ secrets.S3_SECRET_KEY }}" \
          "${{ secrets.S3_GLOBAL_ACC_HOST_BASE }}" "${{ secrets.S3_GLOBAL_ACC_HOST_BASE }}" > ~/.s3cfg
          
          FOLDER="${S3_PATH}"
          [[ "$RELEASE_VERSION" == "nightly"* ]] && FOLDER="${S3_PATH}-nightly"
          s3cmd put ${ARTIFACT} s3://${{ secrets.S3_BUCKET }}/${FOLDER}/$(uname -m)/image/${ARTIFACT}

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.build.outputs.artifact_name }}
          path: ${{ steps.build.outputs.artifact_name }}

  # 3. Android å’Œ RPM æž„å»ºä»»åŠ¡
  build-special:
    name: ${{ matrix.type }}
    needs: set-release-version
    runs-on: ubuntu-latest
    strategy:
      matrix:
        type: [android, rpm]
    steps:
      - uses: actions/checkout@v4
      
      # Android çŽ¯å¢ƒå‡†å¤‡
      - if: matrix.type == 'android'
        uses: actions/setup-node@v4
        with: { node-version: 20 }
      - if: matrix.type == 'android'
        uses: nttld/setup-ndk@v1
        id: setup-ndk
        with: { ndk-version: r26c }
      - if: matrix.type == 'android'
        uses: seanmiddleditch/gha-setup-ninja@v4
      
      - name: Build
        id: build
        env:
          RELEASE_VERSION: ${{ needs.set-release-version.outputs.release_version }}
          NDK: ${{ steps.setup-ndk.outputs.ndk-path }}
        run: |
          if [ "${{ matrix.type }}" == "android" ]; then
            ./build.sh -nap
            echo "artifact_name=$(ls *${RELEASE_VERSION}*.tar.gz | head -n 1)" >> $GITHUB_OUTPUT
            echo "s3_subfolder=arm64-v8a/binary" >> $GITHUB_OUTPUT
          else
            ./build.sh -nr -t ${RELEASE_VERSION}
            echo "artifact_name=$(cd rpm; ls *.rpm | head -n 1)" >> $GITHUB_OUTPUT
            echo "s3_subfolder=$(uname -m)/rpm" >> $GITHUB_OUTPUT
            echo "is_rpm=true" >> $GITHUB_OUTPUT
          fi

      - name: Upload to S3
        if: ${{ env.S3_KEY != '' }}
        env:
          S3_KEY: ${{ secrets.S3_ACCESS_KEY }}
          RELEASE_VERSION: ${{ needs.set-release-version.outputs.release_version }}
          ARTIFACT: ${{ steps.build.outputs.artifact_name }}
          SUBFOLDER: ${{ steps.build.outputs.s3_subfolder }}
        run: |
          sudo apt-get install -y s3cmd
          printf "[default]\naccess_key = %s\nsecret_key = %s\nhost_base = %s\nhost_bucket = %%(bucket)s.%s\n" \
          "${{ secrets.S3_ACCESS_KEY }}" "${{ secrets.S3_SECRET_KEY }}" \
          "${{ secrets.S3_GLOBAL_ACC_HOST_BASE }}" "${{ secrets.S3_GLOBAL_ACC_HOST_BASE }}" > ~/.s3cfg
          
          FILE_PATH=${ARTIFACT}
          TARGET_NAME=${ARTIFACT}
          [[ "${{ steps.build.outputs.is_rpm }}" == "true" ]] && FILE_PATH="rpm/${ARTIFACT}" && TARGET_NAME=$(echo ${ARTIFACT} | sed 's/.el7./-el7-/g')
          
          FOLDER="${S3_PATH}"
          [[ "$RELEASE_VERSION" == "nightly"* ]] && FOLDER="${S3_PATH}-nightly"
          s3cmd put ${FILE_PATH} s3://${{ secrets.S3_BUCKET }}/${FOLDER}/${SUBFOLDER}/${TARGET_NAME}

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.build.outputs.artifact_name }}
          path: ${{ steps.build.outputs.is_rpm == 'true' && format('rpm/{0}', steps.build.outputs.artifact_name) || steps.build.outputs.artifact_name }}

  build-with-gui:
    name: GUI ${{ matrix.os }} ${{ matrix.arch }}
    needs: set-release-version
    if: ${{ !contains(needs.set-release-version.outputs.release_version, 'nightly') }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-24.04
            arch: x86_64
            setup: "sudo apt-get update"
          - os: ubuntu-24.04-arm
            arch: aarch64
            setup: ""
          - os: macos-13
            arch: x86_64
            setup: "export CC=$(brew --prefix llvm@15)/bin/clang; export CXX=$(brew --prefix llvm@15)/bin/clang++"
          - os: macos-latest
            arch: aarch64
            setup: "export CC=$(brew --prefix llvm@15)/bin/clang; export CXX=$(brew --prefix llvm@15)/bin/clang++"
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: 20 }
      - name: Build GUI
        env:
          RELEASE_VERSION: ${{ needs.set-release-version.outputs.release_version }}
          PKG_NAME: pipy-gui
        run: |
          ${{ matrix.setup }}
          ./build.sh -gp -t ${RELEASE_VERSION}
          # ç¡®ä¿åªå–åˆ°ä¸€ä¸ªæ–‡ä»¶å
          echo "artifact_name=$(ls pipy-gui-${RELEASE_VERSION}*.tar.gz | head -n 1)" >> $GITHUB_OUTPUT
      - uses: actions/upload-artifact@v4
        with:
          name: ${{ env.artifact_name }} # æ³¨æ„ï¼šè¿™é‡Œä½¿ç”¨ env.artifact_name å› ä¸ºå®ƒæ˜¯åœ¨ run ä¸­è®¾ç½®çš„ output
          path: ${{ env.artifact_name }}

  # 5. åˆ›å»º Release (æ ¸å¿ƒä¿®æ”¹éƒ¨åˆ†)
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    if: ${{ !contains(needs.set-release-version.outputs.release_version, 'nightly') }}
    needs: [set-release-version, build-core, build-docker, build-with-gui, build-special]
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      # - name: Generate Release Table and Body
      #   env:
      #     REPO: ${{ github.repository }}
      #     TAG: ${{ needs.set-release-version.outputs.release_version }}
      #   run: |
      #     # å®šä¹‰ä¸‹è½½é“¾æŽ¥çš„åŸºç¡€å‰ç¼€
      #     BASE="https://github.com/${REPO}/releases/download/${TAG}"

      #     # è¾…åŠ©å‡½æ•°ï¼šåœ¨ artifacts ç›®å½•ä¸­æŸ¥æ‰¾ç¬¦åˆå…³é”®å­—çš„æ–‡ä»¶å
      #     # å‚æ•° $1: å¿…é¡»åŒ…å«çš„å­—ç¬¦ä¸² (ä¾‹å¦‚ x86_64)
      #     # å‚æ•° $2: (å¯é€‰) å¿…é¡»æŽ’é™¤çš„å­—ç¬¦ä¸² (ä¾‹å¦‚ gui)
      #     find_file() {
      #       if [ -z "$2" ]; then
      #         find artifacts -name "*$1*" -type f -exec basename {} \; | head -n 1
      #       else
      #         find artifacts -name "*$1*" ! -name "*$2*" -type f -exec basename {} \; | head -n 1
      #       fi
      #     }

      #     # åŠ¨æ€æŸ¥æ‰¾æ–‡ä»¶å
      #     X86_BINARY=$(find_file "x86_64.tar.gz" "gui")
      #     AARCH64_BINARY=$(find_file "aarch64.tar.gz" "gui")
          
      #     # MacOS çš„æ–‡ä»¶åé€šå¸¸ä¸åŒ…å« OS åå­—ï¼Œæˆ–è€…åŒ…å« darwinï¼Œæ ¹æ®åŽŸé€»è¾‘æŽ¨æ–­ï¼š
      #     # åŽŸé€»è¾‘ x86-macos äº§å‡ºçš„å°±æ˜¯ tar.gzã€‚ä¸ºäº†åŒºåˆ† Linuxï¼Œæˆ‘ä»¬éœ€è¦ä¾èµ– artifacts çš„ç›®å½•ç»“æž„æˆ–è€…æ–‡ä»¶åå·®å¼‚ã€‚
      #     # å‡è®¾ artifacts/æ–‡ä»¶å/æ–‡ä»¶å (download-artifact é»˜è®¤è¡Œä¸º)
      #     # è¿™é‡Œä¸ºäº†ç¨³å¥ï¼Œç›´æŽ¥å…¨ç›˜æœç´¢ã€‚å¦‚æžœæ–‡ä»¶åç›¸åŒï¼Œåˆ™éœ€è¦ä¾é  artifact name (å³æ–‡ä»¶å¤¹å) åŒºåˆ†ã€‚
      #     # ç®€åŒ–èµ·è§ï¼Œå‡è®¾æ–‡ä»¶åé‡ŒåŒ…å«æž¶æž„ä¿¡æ¯ã€‚
          
      #     # ä¿®æ­£ç­–ç•¥ï¼šç”±äºŽæ–‡ä»¶åå¯èƒ½é‡å¤ (linux å’Œ mac å¯èƒ½äº§ç”ŸåŒåæ–‡ä»¶?)ï¼Œ
      #     # æœ€å¥½æ‰“å°ä¸€ä¸‹çœ‹çœ‹ç»“æž„ï¼Œä½†è¿™é‡Œæˆ‘ä»¬å…ˆæŒ‰ç…§æƒ¯ä¾‹å‡è®¾æ–‡ä»¶ååŒ…å« os ä¿¡æ¯ã€‚
      #     # å¦‚æžœæ–‡ä»¶åå®Œå…¨ä¸€æ ·ï¼Œä¸‹é¢çš„é€»è¾‘å¯èƒ½éœ€è¦è°ƒæ•´ä¸ºæœç´¢ç‰¹å®šè·¯å¾„ã€‚
          
      #     # å‡è®¾ build.sh ç”Ÿæˆçš„æ–‡ä»¶ååŒ…å« pipy-version-os-arch.tar.gz
      #     # å¦‚æžœæ²¡æœ‰åŒºåˆ† OSï¼Œåˆ™éœ€è¦æ›´ç²¾ç»†çš„ findï¼Œæ¯”å¦‚ find artifacts/pipy-*-linux-x86...
          
      #     # é‡æ–°å®šä¹‰æŸ¥æ‰¾é€»è¾‘ï¼Œæ›´åŠ å®½å®¹ï¼Œåªè¦æ‰¾åˆ°å¯¹åº”æ–‡ä»¶å³å¯ï¼š
      #     X86_RPM=$(find_file ".rpm")
      #     ANDROID=$(find_file "android" "gui") # æˆ–è€…æ ¹æ®åŽç¼€
      #     if [ -z "$ANDROID" ]; then ANDROID=$(find_file "arm64-v8a"); fi

      #     X86_BINARY_GUI=$(find_file "gui" "x86_64")
      #     AARCH64_BINARY_GUI=$(find_file "gui" "aarch64")

      #     # é‡æ–°æŸ¥æ‰¾ MacOS (é€šå¸¸åœ¨ build.sh ä¸­ä¼šå¸¦ä¸Š darwin æˆ– macos)
      #     # å¦‚æžœæ–‡ä»¶åé‡Œä¸å¸¦ OSï¼Œæˆ‘ä»¬å¯èƒ½æ— æ³•åŒºåˆ† Linux å’Œ Mac çš„åŒ…ã€‚
      #     # é‰´äºŽåŽŸè„šæœ¬ç›´æŽ¥ä¸Šä¼  binaryï¼Œå‡è®¾åå­—æ˜¯æœ‰åŒºåˆ†åº¦çš„ã€‚
      #     X86_MACOS=$(find_file "darwin" "x86_64")
      #     if [ -z "$X86_MACOS" ]; then X86_MACOS=$X86_BINARY; fi # Fallback if specific mac name not found
          
      #     AARCH64_MACOS=$(find_file "darwin" "aarch64")
      #      if [ -z "$AARCH64_MACOS" ]; then AARCH64_MACOS=$AARCH64_BINARY; fi

      #     # ç”Ÿæˆ Markdown è¡¨æ ¼
      #     cat > release_body.md << EOF
      #     **Download based on your OS:**

      #     | OS | Arch | Download | Download (with GUI) |
      #     |---|---|---|---|
      #     | ðŸ§ Linux | x86_64 | [${X86_BINARY}](${BASE}/${X86_BINARY}) | [${X86_BINARY_GUI}](${BASE}/${X86_BINARY_GUI}) |
      #     | ðŸ§ Linux | aarch64 | [${AARCH64_BINARY}](${BASE}/${AARCH64_BINARY}) | [${AARCH64_BINARY_GUI}](${BASE}/${AARCH64_BINARY_GUI}) |
      #     | ðŸŽ macOS | x86_64 | [${X86_MACOS}](${BASE}/${X86_MACOS}) | [${X86_MACOS_GUI}](${BASE}/${X86_MACOS_GUI}) |
      #     | ðŸŽ macOS | aarch64 | [${AARCH64_MACOS}](${BASE}/${AARCH64_MACOS}) | [${AARCH64_MACOS_GUI}](${BASE}/${AARCH64_MACOS_GUI}) |
      #     | ðŸ§ Linux (RPM) | x86_64 | [${X86_RPM}](${BASE}/${X86_RPM}) | - |
      #     | ðŸ¤– Android | arm64-v8a | [${ANDROID}](${BASE}/${ANDROID}) | - |
      #     EOF
          
      #     echo "Generated Body:"
      #     cat release_body.md

      - name: Create draft release
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          # body_path: release_body.md
          # è¿™é‡Œçš„ **/* ä¼šé€’å½’ä¸Šä¼  artifacts ç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶
          files: artifacts/**/*

          
  save-log:
    if: ${{ always() && !contains(join(needs.*.result, ','), 'failure') }}
    needs: [set-release-version, build-core, build-docker, build-with-gui, build-special, create-release]
    runs-on: ubuntu-latest
    steps:
      - name: Save log
        if: ${{ env.REPO_DISPATCH_PAT != '' }}
        env:
          REPO_DISPATCH_PAT: ${{ secrets.REPO_DISPATCH_PAT }}
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.REPO_DISPATCH_PAT }}
          repository: ${{ secrets.REPO_FOR_LOG }}
          event-type: save-log
          client-payload: '{"github": ${{toJSON(github)}}, "release_version": "${{needs.set-release-version.outputs.release_version}}"}'