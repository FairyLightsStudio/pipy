name: Release

on:
  push:
    tags:
      - '*'

permissions:
  contents: write # éœ€è¦æƒé™åˆ›å»º Release

env:
  IMAGE: flomesh/pipy
  PKG_NAME: pipy
  S3_PATH: repo/pipy

defaults:
  run:
    shell: bash

jobs:
  set-release-version:
    name: Set Version
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set RELEASE_VERSION
        id: version
        run: |
          CI_COMMIT_DATE=$(date +%Y%m%d%H%M)
          echo "CI_COMMIT_DATE=${CI_COMMIT_DATE}" >> $GITHUB_ENV
          git fetch --tags --force
          RELEASE_VERSION=`git name-rev --tags --name-only $(git rev-parse HEAD)`
          if [ $RELEASE_VERSION = 'undefined' ]; then
              echo "release_version=nightly-${CI_COMMIT_DATE}" >> $GITHUB_OUTPUT
          else
              echo "release_version=${RELEASE_VERSION}" >> $GITHUB_OUTPUT
          fi
    outputs:
      release_version: ${{steps.version.outputs.release_version}}

  build-core:
    name: Core ${{ matrix.os }} ${{ matrix.arch }}
    needs: set-release-version
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-24.04
            arch: x86_64
            setup: ""
          - os: ubuntu-24.04-arm
            arch: aarch64
            setup: ""
          - os: macos-15-intel
            arch: x86_64
            setup: "export CC=$(brew --prefix llvm@15)/bin/clang; export CXX=$(brew --prefix llvm@15)/bin/clang++"
          - os: macos-latest
            arch: aarch64
            setup: "export CC=$(brew --prefix llvm@15)/bin/clang; export CXX=$(brew --prefix llvm@15)/bin/clang++"
    steps:
      - name: Install Dependencies (macOS)
        if: contains(matrix.os, 'macos')
        run: brew install llvm@15
      - uses: actions/checkout@v4
      - name: Build
        id: build
        env:
          RELEASE_VERSION: ${{ needs.set-release-version.outputs.release_version }}
        run: |
          ${{ matrix.setup }}
          ./build.sh -p -t ${RELEASE_VERSION}
          # è¾“å‡ºæ–‡ä»¶åä¾›åŽç»­æ­¥éª¤ä½¿ç”¨
          echo "artifact_name=$(ls *${RELEASE_VERSION}*.tar.gz | head -n 1)" >> $GITHUB_OUTPUT

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.build.outputs.artifact_name }}
          path: ${{ steps.build.outputs.artifact_name }}

  # 2. Docker æž„å»ºä»»åŠ¡
  build-docker:
    name: Docker ${{ matrix.arch }}
    needs: set-release-version
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          - arch: x86_64
            runner: ubuntu-latest
          - arch: aarch64
            runner: ubuntu-24.04-arm
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - name: Build Image
        id: build
        env:
          DOCKER_BUILDKIT: 1
          RELEASE_VERSION: ${{ needs.set-release-version.outputs.release_version }}
        run: |
          ./build.sh -ncp -t ${RELEASE_VERSION}
          echo "artifact_name=$(ls *${RELEASE_VERSION}*.tar.gz | head -n 1)" >> $GITHUB_OUTPUT

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.build.outputs.artifact_name }}
          path: ${{ steps.build.outputs.artifact_name }}

  # 3. Android å’Œ RPM æž„å»ºä»»åŠ¡
  build-special:
    name: ${{ matrix.type }}
    needs: set-release-version
    runs-on: ubuntu-latest
    strategy:
      matrix:
        type: [android, rpm]
    steps:
      - uses: actions/checkout@v4
      
      # Android çŽ¯å¢ƒå‡†å¤‡
      - if: matrix.type == 'android'
        uses: actions/setup-node@v4
        with: { node-version: 20 }
      - if: matrix.type == 'android'
        uses: nttld/setup-ndk@v1
        id: setup-ndk
        with: { ndk-version: r26c }
      - if: matrix.type == 'android'
        uses: seanmiddleditch/gha-setup-ninja@v4
      
      - name: Build
        id: build
        env:
          RELEASE_VERSION: ${{ needs.set-release-version.outputs.release_version }}
          NDK: ${{ steps.setup-ndk.outputs.ndk-path }}
        run: |
          if [ "${{ matrix.type }}" == "android" ]; then
            ./build.sh -nap
            echo "artifact_name=$(ls *${RELEASE_VERSION}*.tar.gz | head -n 1)" >> $GITHUB_OUTPUT
            echo "s3_subfolder=arm64-v8a/binary" >> $GITHUB_OUTPUT
          else
            ./build.sh -nr -t ${RELEASE_VERSION}
            echo "artifact_name=$(cd rpm; ls *.rpm | head -n 1)" >> $GITHUB_OUTPUT
            echo "s3_subfolder=$(uname -m)/rpm" >> $GITHUB_OUTPUT
            echo "is_rpm=true" >> $GITHUB_OUTPUT
          fi

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.build.outputs.artifact_name }}
          path: ${{ steps.build.outputs.is_rpm == 'true' && format('rpm/{0}', steps.build.outputs.artifact_name) || steps.build.outputs.artifact_name }}

  build-with-gui:
    name: GUI ${{ matrix.os }} ${{ matrix.arch }}
    needs: set-release-version
    if: ${{ !contains(needs.set-release-version.outputs.release_version, 'nightly') }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-24.04
            arch: x86_64
            setup: "sudo apt-get update"
          - os: ubuntu-24.04-arm
            arch: aarch64
            setup: ""
          - os: macos-15-intel
            arch: x86_64
            setup: "export CC=$(brew --prefix llvm@15)/bin/clang; export CXX=$(brew --prefix llvm@15)/bin/clang++"
          - os: macos-latest
            arch: aarch64
            setup: "export CC=$(brew --prefix llvm@15)/bin/clang; export CXX=$(brew --prefix llvm@15)/bin/clang++"
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: 20 }
      - name: Install Dependencies (macOS)
        if: contains(matrix.os, 'macos')
        run: brew install llvm@15
      - name: Build GUI
        id: build
        env:
          RELEASE_VERSION: ${{ needs.set-release-version.outputs.release_version }}
          PKG_NAME: pipy-gui
        run: |
          ${{ matrix.setup }}
          ./build.sh -gp -t ${RELEASE_VERSION}
          # ç¡®ä¿åªå–åˆ°ä¸€ä¸ªæ–‡ä»¶å
          echo "artifact_name=$(ls pipy-gui-${RELEASE_VERSION}*.tar.gz | head -n 1)" >> $GITHUB_OUTPUT
      - uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.build.outputs.artifact_name }}
          path: ${{ steps.build.outputs.artifact_name }}

  push-to-s3:
    name: Push to S3
    needs: [build-core, build-docker, build-special]
    runs-on: ubuntu-latest
    if: ${{ secrets.S3_ACCESS_KEY != '' }}
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Install s3cmd
        run: sudo apt-get install -y s3cmd

      - name: Configure S3
        run: |
          printf "[default]\naccess_key = %s\nsecret_key = %s\nhost_base = %s\nhost_bucket = %%(bucket)s.%s\n" \
          "${{ secrets.S3_ACCESS_KEY }}" "${{ secrets.S3_SECRET_KEY }}" \
          "${{ secrets.S3_GLOBAL_ACC_HOST_BASE }}" "${{ secrets.S3_GLOBAL_ACC_HOST_BASE }}" > ~/.s3cfg

      - name: Batch Upload
        env:
          RELEASE_VERSION: ${{ needs.set-release-version.outputs.release_version }}
          S3_ROOT: ${{ env.S3_PATH }}
          BUCKET: ${{ secrets.S3_BUCKET }}
        run: |
          BASE_PATH="${S3_ROOT}"
          if [[ "$RELEASE_VERSION" == "nightly"* ]]; then
            BASE_PATH="${S3_ROOT}-nightly"
          fi
          
          echo "Target S3 Base Path: s3://${BUCKET}/${BASE_PATH}"

          find artifacts -type f | while read FILE; do
            FILENAME=$(basename "$FILE")
            
            # é»˜è®¤å€¼
            ARCH="x86_64"
            TYPE="binary"
            TARGET_NAME="$FILENAME"
            
            # --- 1. æž¶æž„è¯†åˆ« ---
            if [[ "$FILENAME" == *"aarch64"* ]]; then
              ARCH="aarch64"
            elif [[ "$FILENAME" == *"arm64"* ]] || [[ "$FILENAME" == *"android"* ]]; then
              ARCH="arm64-v8a" # Android ä¸“å±žæž¶æž„å
            else
              ARCH="x86_64"
            fi
            
            # --- 2. ç±»åž‹è¯†åˆ« ---
            if [[ "$FILENAME" == *".rpm" ]]; then
              TYPE="rpm"
              # RPM ç‰¹æ®Šé‡å‘½å: .el7. -> -el7-
              TARGET_NAME=$(echo "$FILENAME" | sed 's/\.el7\./-el7-/g')
              # RPM æž¶æž„é€šå¸¸å°±æ˜¯ x86_64ï¼Œä¸Šé¢é€»è¾‘å·²è¦†ç›–
              
            elif [[ "$FILENAME" == *"alpine"* ]]; then
              TYPE="image"
              
            elif [[ "$FILENAME" == *"android"* ]]; then
              TYPE="binary"
              
            elif [[ "$FILENAME" == *"macos"* ]]; then
              TYPE="binary"
              
            elif [[ "$FILENAME" == *"generic_linux"* ]]; then
              TYPE="binary"
              
            elif [[ "$FILENAME" == *"gui"* ]]; then
              echo "Skipping GUI file upload to S3: $FILENAME"
              continue
            else
              echo "Unknown file type: $FILENAME, skipping..."
              continue
            fi
            
            S3_URI="s3://${BUCKET}/${BASE_PATH}/${ARCH}/${TYPE}/${TARGET_NAME}"
            echo "Uploading $FILENAME -> $S3_URI"
            s3cmd put "$FILE" "$S3_URI"
          done


  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    if: ${{ !contains(needs.set-release-version.outputs.release_version, 'nightly') }}
    needs: [build-core, build-docker, build-with-gui, build-special]
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Generate Release Body
        env:
          REPO: ${{ github.repository }}
          TAG: ${{ needs.set-release-version.outputs.release_version }}
        run: |
          BASE="https://github.com/${REPO}/releases/download/${TAG}"

          # è¾…åŠ©å‡½æ•°ï¼šæŸ¥æ‰¾æ–‡ä»¶
          # find_file "å…³é”®å­—1" "æŽ’é™¤å…³é”®å­—"
          find_file() {
            local KEYWORD=$1
            local EXCLUDE=$2
            if [ -z "$EXCLUDE" ]; then
              find artifacts -name "*${KEYWORD}*" -type f -exec basename {} \; | head -n 1
            else
              find artifacts -name "*${KEYWORD}*" ! -name "*${EXCLUDE}*" -type f -exec basename {} \; | head -n 1
            fi
          }

          # --- æ ¹æ®å®žé™…æ–‡ä»¶åç‰¹å¾æŸ¥æ‰¾ ---
          
          # Linux Core (å…³é”®å­—: generic_linux + æž¶æž„ + ä¸å«gui)
          X86_BINARY=$(find_file "generic_linux-x86_64" "gui")
          AARCH64_BINARY=$(find_file "generic_linux-aarch64" "gui")
          
          # macOS Core (å…³é”®å­—: macos + æž¶æž„ + ä¸å«gui)
          X86_MACOS=$(find_file "macos-x86_64" "gui")
          AARCH64_MACOS=$(find_file "macos-aarch64" "gui")
          
          # Linux GUI (å…³é”®å­—: generic_linux + gui)
          X86_BINARY_GUI=$(find_file "generic_linux-x86_64" "") # è¿™é‡Œå…¶å®žåº”è¯¥æ˜¾å¼æœ guiï¼Œä½†ä¸‹é¢çš„é€»è¾‘å·²ç»è¿‡æ»¤äº†
          # æ›´ä¸¥è°¨çš„å†™æ³•ï¼š
          X86_BINARY_GUI=$(find artifacts -name "*pipy-gui*generic_linux-x86_64*" -type f -exec basename {} \; | head -n 1)
          AARCH64_BINARY_GUI=$(find artifacts -name "*pipy-gui*generic_linux-aarch64*" -type f -exec basename {} \; | head -n 1)
          
          # macOS GUI
          X86_MACOS_GUI=$(find artifacts -name "*pipy-gui*macos-x86_64*" -type f -exec basename {} \; | head -n 1)
          AARCH64_MACOS_GUI=$(find artifacts -name "*pipy-gui*macos-aarch64*" -type f -exec basename {} \; | head -n 1)

          # RPM & Android
          X86_RPM=$(find_file ".rpm" "")
          ANDROID=$(find_file "android" "")

          # ç”Ÿæˆè¡¨æ ¼
          cat > release_body.md << EOF
          **Download based on your OS:**

          | OS | Arch | Download | Download (with GUI) |
          |---|---|---|---|
          | ðŸ§ Linux | x86_64 | [${X86_BINARY}](${BASE}/${X86_BINARY}) | [${X86_BINARY_GUI}](${BASE}/${X86_BINARY_GUI}) |
          | ðŸ§ Linux | aarch64 | [${AARCH64_BINARY}](${BASE}/${AARCH64_BINARY}) | [${AARCH64_BINARY_GUI}](${BASE}/${AARCH64_BINARY_GUI}) |
          | ðŸŽ macOS | x86_64 | [${X86_MACOS}](${BASE}/${X86_MACOS}) | [${X86_MACOS_GUI}](${BASE}/${X86_MACOS_GUI}) |
          | ðŸŽ macOS | aarch64 | [${AARCH64_MACOS}](${BASE}/${AARCH64_MACOS}) | [${AARCH64_MACOS_GUI}](${BASE}/${AARCH64_MACOS_GUI}) |
          | ðŸ§ Linux (RPM) | x86_64 | [${X86_RPM}](${BASE}/${X86_RPM}) | - |
          | ðŸ¤– Android | arm64-v8a | [${ANDROID}](${BASE}/${ANDROID}) | - |
          EOF
          
          echo "Release Note Content:"
          cat release_body.md

      - name: Create draft release
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          body_path: release_body.md
          files: artifacts/**/*

  save-log:
    if: ${{ always() && !contains(join(needs.*.result, ','), 'failure') }}
    needs: [build-core, build-docker, build-with-gui, build-special, create-release]
    runs-on: ubuntu-latest
    steps:
      - name: Save log
        if: ${{ env.REPO_DISPATCH_PAT != '' }}
        env:
          REPO_DISPATCH_PAT: ${{ secrets.REPO_DISPATCH_PAT }}
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.REPO_DISPATCH_PAT }}
          repository: ${{ secrets.REPO_FOR_LOG }}
          event-type: save-log
          client-payload: '{"github": ${{toJSON(github)}}, "release_version": "${{needs.set-release-version.outputs.release_version}}"}'